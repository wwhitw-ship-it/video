<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScriptFlow - Hair Stylist Edition</title>
    
    <!-- 引入 Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Noto+Serif+TC:wght@700;900&display=swap" rel="stylesheet">

    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- 3. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. React 環境 (使用穩定的 CDN) -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0"
        }
    }
    </script>

    <!-- 5. 錯誤捕捉樣式 -->
    <style>
        #error-display { display: none; padding: 20px; background: #fee2e2; color: #b91c1c; border: 1px solid #f87171; margin: 20px; border-radius: 8px; font-family: monospace; }
        body { font-family: "Noto Sans TC", sans-serif; }
        .font-serif { font-family: "Noto Serif TC", serif; }

        @media print {
            @page { size: landscape; margin: 10mm; }
            body { background: white; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .print\:hidden { display: none !important; }
            .print\:block { display: block !important; }
            .print\:shadow-none { box-shadow: none !important; }
            .print\:border-none { border: none !important; }
            .print\:w-full { width: 100% !important; max-width: none !important; }
            .bg-stone-100 { background-color: #f5f5f4 !important; }
            .bg-stone-50 { background-color: #fafaf9 !important; }
            .page-break { break-after: page; page-break-after: always; }
            tr { break-inside: avoid; page-break-inside: avoid; }
            .page-break-avoid { break-inside: avoid; page-break-inside: avoid; }
            .print\:text-sm { font-size: 0.875rem !important; line-height: 1.25rem !important; }
            .print\:text-xs { font-size: 0.75rem !important; line-height: 1rem !important; }
            .print\:p-1 { padding: 0.25rem !important; }
            .print\:p-2 { padding: 0.5rem !important; }
            .print\:mb-1 { margin-bottom: 0.25rem !important; }
            .print\:h-auto { height: auto !important; }
            ::-webkit-scrollbar { display: none; }
        }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .custom-scrollbar::-webkit-scrollbar { height: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        .capture-target { background-color: white; }
        .force-wrap { white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; }
    </style>
</head>
<body class="bg-slate-50 text-stone-800">
    
    <div id="error-display"></div>
    <div id="root"></div>

    <!-- 全局錯誤捕捉 -->
    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            const display = document.getElementById('error-display');
            display.style.display = 'block';
            display.innerHTML = `<strong>⚠️ 發生錯誤：</strong><br>${message}<br><small>${source}:${lineno}</small>`;
        };
    </script>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        // 注意：將 File 改名為 FileIcon 避免與瀏覽器原生 File 物件衝突
        import { 
            Printer, RefreshCcw, Sparkles, Scissors, Settings, Key, AlertCircle, 
            Plus, Trash2, User, Save, FolderOpen, X, Lightbulb, Check, FileText, 
            Copy, Layout, Download, Image as ImageIcon, Briefcase, Smile, Palette,
            Table, Upload, CheckSquare, Square, FileSpreadsheet, File as FileIcon
        } from 'lucide-react';

        const STORAGE_KEY = 'hair_scripts_v3_full'; 
        const OPTIONS_KEY = 'hair_scripts_options';   

        const DEFAULT_SERVICES = ["專業剪髮 (Cut)", "韓系燙髮 (Perm)", "縮毛矯正 (Rebonding)", "質感單色染 (Color)", "歐美手刷染 (Balayage)", "光線染/耳圈染 (Highlight)", "深層結構護髮 (Treatment)", "頭皮檢測護理 (Scalp)", "男士油頭/造型 (Barber)", "婚禮/活動造型 (Styling)"];
        const DEFAULT_AUDIENCES = ["追求質感的上班族", "預算有限的學生族群", "細軟扁塌髮困擾者", "自然捲/毛躁髮困擾者", "極度受損髮/漂髮客群", "產後落髮/頭皮敏感者", "白髮遮蓋/熟齡客群", "注重門面的商務男士", "韓系風格愛好者", "特殊色/歐美挑染控", "忙碌沒空打理的媽媽", "短髮控/想剪短的女生"];
        const DEFAULT_STYLES = ["質感氛圍 (Aesthetic)", "專業教學 (Tutorial)", "日常紀錄 (Vlog)", "幽默短劇 (Funny)", "改造前後 (Before/After)", "ASMR/療癒過程", "避雷/迷思破解", "快速問答 (Q&A)"];

        const CreatableSelect = ({ label, icon: Icon, value, onChange, onAdd, listId, options }) => {
            return (
                <div>
                    <label className="text-sm font-bold text-stone-500 uppercase tracking-wider block mb-1 flex items-center">
                        {Icon && <Icon size={14} className="mr-1" />} {label}
                    </label>
                    <div className="flex gap-2 relative">
                        <input type="text" list={listId} value={value || ''} onChange={(e) => onChange(e.target.value)} className="w-full border-b-2 border-stone-300 py-1.5 text-base text-black focus:outline-none focus:border-black bg-transparent placeholder-stone-400" placeholder={`選擇或輸入...`} />
                        <button type="button" onClick={() => onAdd(value)} className="p-2 bg-stone-200 hover:bg-stone-300 hover:text-black rounded text-stone-700 transition-colors flex-shrink-0 cursor-pointer z-10" title="新增至常用清單"><Plus size={18} /></button>
                    </div>
                    <datalist id={listId}>{options.map((opt, idx) => <option key={idx} value={opt} />)}</datalist>
                </div>
            );
        };

        const ScriptPaper = ({ script, isPrinting = false, onChange, onDeleteRow }) => {
            if (!script) return null;
            const InputComponent = ({ value, onUpdate, className, placeholder, multiline = false, center = false, printClassName = "" }) => {
                return (
                    <>
                        {multiline ? (
                            <textarea value={value || ""} onChange={(e) => onUpdate(e.target.value)} className={`${className} print:hidden focus:outline-none focus:bg-stone-50 resize-none bg-transparent`} placeholder={placeholder} />
                        ) : (
                            <input value={value || ""} onChange={(e) => onUpdate(e.target.value)} className={`${className} print:hidden focus:outline-none focus:bg-stone-50 bg-transparent`} placeholder={placeholder} />
                        )}
                        <div className={`hidden print:block force-wrap ${className.replace('h-24', 'h-auto').replace('h-20', 'h-auto')} ${printClassName} ${center ? 'text-center' : ''}`} style={{border: 'none', outline: 'none'}}>
                            {value}
                        </div>
                    </>
                );
            };

            return (
                <div className={`bg-white max-w-[297mm] mx-auto p-[15mm] shadow-lg print:shadow-none print:w-full print:max-w-none print:p-0 print:m-0 flex flex-col ${!isPrinting ? 'animate-in fade-in zoom-in-95 duration-300' : ''}`}>
                    <div className="flex justify-between items-end border-b-4 border-stone-800 pb-4 mb-4 print:pb-2 print:mb-3 print:border-stone-800">
                        <div>
                            <h2 className="text-4xl font-serif font-black text-black leading-tight print:text-3xl">{script.formData.topic || '未命名主題'}</h2>
                            <div className="text-xs text-stone-600 mt-2 font-bold flex gap-2 flex-wrap print:mt-2 print:text-xs">
                                <span className="bg-stone-100 px-2 py-1 rounded print:border print:border-stone-200 print:bg-stone-50">Target: {script.formData.audience}</span>
                                {script.formData.product && <span className="bg-stone-100 px-2 py-1 rounded print:border print:border-stone-200 print:bg-stone-50">Item: {script.formData.product}</span>}
                                <span className="bg-stone-100 px-2 py-1 rounded print:border print:border-stone-200 print:bg-stone-50">Time: {script.formData.duration}</span>
                            </div>
                        </div>
                        <div className="text-right flex-shrink-0 ml-4"><div className="text-sm font-bold text-stone-400 uppercase tracking-widest">Hair Script</div><div className="text-xs text-stone-400 font-medium">{new Date().toLocaleDateString()}</div></div>
                    </div>

                    <div className="flex flex-col gap-4 print:gap-4">
                        <div className="p-4 bg-stone-100 border-l-4 border-stone-400 rounded-r-md print:bg-stone-100 print:border-stone-400 print:p-3 print:mb-1">
                            <div className="flex items-center gap-2 mb-1 text-stone-700 font-bold"><FileText size={14} /><span className="text-xs uppercase tracking-wider">影片概念簡述 (Concept)</span></div>
                            <InputComponent multiline value={script.scriptConcept} onUpdate={(v) => onChange('scriptConcept', v)} className="w-full text-lg leading-relaxed text-stone-800 font-medium" printClassName="print:text-sm" placeholder="AI 生成的影片概念..." />
                        </div>
                        <div className="border-2 border-stone-300 flex-1 print:border-2 print:border-stone-300 rounded-sm overflow-hidden">
                            <table className="w-full border-collapse table-fixed">
                                <thead>
                                    <tr className="bg-stone-200 text-stone-800 print:bg-stone-200">
                                        <th className="w-[10%] py-2 border-r-2 border-stone-300 text-sm font-bold text-center print:border-stone-300 print:text-xs print:py-1">段落</th>
                                        <th className="w-[45%] py-2 border-r-2 border-stone-300 text-sm font-bold text-center print:border-stone-300 print:text-xs print:py-1">大綱重點 (Outline)</th>
                                        <th className="w-[45%] py-2 text-sm font-bold text-center print:text-xs print:py-1">參考語句 (Ref)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {script.scriptData.map((row) => (
                                        <tr key={row.id} className="border-t-2 border-stone-300 group hover:bg-stone-50 transition-colors print:border-stone-300">
                                            <td className="p-2 border-r-2 border-stone-300 text-center align-middle relative bg-stone-50 print:bg-stone-50 print:border-stone-300 print:p-1">
                                                <InputComponent value={row.section} onUpdate={(v) => onChange('section', v, row.id)} className="font-serif text-lg font-black text-black w-full text-center mb-0.5" printClassName="print:text-base" center />
                                                {!isPrinting && <button onClick={() => onDeleteRow(row.id)} className="absolute left-1 top-1 text-stone-300 hover:text-red-400 opacity-0 group-hover:opacity-100 print:hidden"><Trash2 size={12} /></button>}
                                            </td>
                                            <td className="p-0 border-r-2 border-stone-300 align-top relative print:border-stone-300">
                                                <InputComponent multiline value={row.visual} onUpdate={(v) => onChange('visual', v, row.id)} className="w-full h-24 p-4 text-base leading-relaxed text-black font-medium print:p-3 print:text-sm" placeholder="輸入重點..." />
                                            </td>
                                            <td className="p-0 align-top relative">
                                                <InputComponent multiline value={row.dialogue} onUpdate={(v) => onChange('dialogue', v, row.id)} className="w-full h-24 p-4 text-base leading-relaxed text-black font-medium print:p-3 print:text-sm" placeholder="輸入台詞..." />
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                        <div className="grid grid-cols-2 gap-6 mt-1 pt-2 border-t-2 border-stone-200 page-break-avoid print:border-stone-200 print:gap-4 print:pt-2">
                            <div className="p-3 bg-stone-50 rounded border border-stone-200 print:bg-stone-50 print:border-stone-200 print:p-2">
                                <div className="flex items-center gap-2 mb-2 text-stone-500 font-bold"><Briefcase size={14} /><span className="text-xs uppercase tracking-wider">拍攝道具 (Props)</span></div>
                                <InputComponent multiline value={script.scriptProps} onUpdate={(v) => onChange('scriptProps', v)} className="w-full text-sm text-stone-800 font-medium" placeholder="需要的道具..." />
                            </div>
                            <div className="p-3 bg-stone-50 rounded border border-stone-200 print:bg-stone-50 print:border-stone-200 print:p-2">
                                <div className="flex items-center gap-2 mb-2 text-stone-500 font-bold"><Smile size={14} /><span className="text-xs uppercase tracking-wider">模特兒提示 (Model)</span></div>
                                <InputComponent multiline value={script.scriptModelTips} onUpdate={(v) => onChange('scriptModelTips', v)} className="w-full text-sm text-stone-800 font-medium" placeholder="模特兒條件..." />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const generateMockData = (topic) => ({ concept: `以「${topic || '未命名'}」為主題的短片。`, props: "尖尾梳、圓梳、定型液", modelTips: "髮長過肩", script: [{ id: 1, section: "起", visual: "設計師對著鏡頭做出『母湯』手勢。", dialogue: "你是那種洗完頭直接包著毛巾一小時的人嗎？" }, { id: 2, section: "承", visual: "快速示範錯誤 vs 正確吹整。", dialogue: "這樣包只會讓頭皮悶住發臭，髮根還會塌到貼頭皮。" }, { id: 3, section: "轉", visual: "展示吹乾後的蓬鬆髮根。", dialogue: "其實只要洗完立刻逆向吹乾，蓬鬆度直接撐一整天。" }, { id: 4, section: "合", visual: "設計師笑著指下方資訊欄。", dialogue: "想知道你的髮質適合哪種護髮？留言告訴你！" }] });
        const generateMockTopics = (audience) => [`3分鐘快速出門造型`, `顯白髮色推薦 Top3`];

        const callGeminiAPI = async (apiKey, formData) => {
            const cleanKey = apiKey ? apiKey.trim() : "";
            if (!cleanKey) throw new Error("請先設定 API Key");
            const prompt = `你是一個專業的美髮短影音腳本企劃。請根據以下資訊生成腳本：主題：${formData.topic}、產品：${formData.product||'無'}、風格：${formData.style}、受眾：${formData.audience}、備註：${formData.notes||'無'}、時長：${formData.duration}。任務：1.影片概念(Concept)。2.道具(Props)。3.模特兒(Model Tips)。4.大綱(Outline)。5.台詞(Dialogue)。請回傳純JSON格式：{ "concept": "...", "props": "...", "modelTips": "...", "script": [ { "section": "起", "visual": "...", "dialogue": "..." }, ... ] }`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${encodeURIComponent(cleanKey)}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                const text = data.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim();
                const parsed = JSON.parse(text);
                const scriptWithIds = parsed.script.map((item, index) => ({ ...item, id: Date.now() + index, section: item.section ? item.section.substring(0, 1) : "段" }));
                return { concept: parsed.concept || "", props: parsed.props || "", modelTips: parsed.modelTips || "", script: scriptWithIds };
            } catch (error) { console.error(error); throw error; }
        };

        const callGeminiTopicsAPI = async (apiKey, formData) => {
            const cleanKey = apiKey ? apiKey.trim() : "";
            if (!cleanKey) throw new Error("請先設定 API Key");
            const prompt = `美髮IG Reels主題發想，產品：${formData.product}、受眾：${formData.audience}。請給3個短標題(JSON string array)。`;
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${encodeURIComponent(cleanKey)}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim();
                return JSON.parse(text);
            } catch (error) { console.error(error); throw error; }
        };

        function App() {
            const [clients, setClients] = useState([]);
            const [customOptions, setCustomOptions] = useState({ services: [], audiences: [], styles: [] });
            const [selectedClientId, setSelectedClientId] = useState(null);
            const [selectedScriptId, setSelectedScriptId] = useState(null);
            const [isSelectionMode, setIsSelectionMode] = useState(false);
            const [selectedScriptIds, setSelectedScriptIds] = useState(new Set());
            const [isBatchPrinting, setIsBatchPrinting] = useState(false); 
            const [isAddingClient, setIsAddingClient] = useState(false);
            const [newClientName, setNewClientName] = useState("");
            const [isGenerating, setIsGenerating] = useState(false);
            const [isGeneratingTopics, setIsGeneratingTopics] = useState(false);
            const [suggestedTopics, setSuggestedTopics] = useState([]);
            const [apiKey, setApiKey] = useState('');
            const [showSettings, setShowSettings] = useState(false);
            const [apiError, setApiError] = useState(null);
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            const [isDownloadingImage, setIsDownloadingImage] = useState(false);
            const [isCapturing, setIsCapturing] = useState(false); 
            const scriptRef = useRef(null);

            useEffect(() => {
                const savedApiKey = localStorage.getItem('gemini_api_key');
                if (savedApiKey) setApiKey(savedApiKey);
                const savedOptions = localStorage.getItem(OPTIONS_KEY);
                if (savedOptions) { try { const parsed = JSON.parse(savedOptions); setCustomOptions({ services: Array.isArray(parsed.services) ? parsed.services : [], audiences: Array.isArray(parsed.audiences) ? parsed.audiences : [], styles: Array.isArray(parsed.styles) ? parsed.styles : [] }); } catch(e) {} }
                const savedClients = localStorage.getItem(STORAGE_KEY);
                if (savedClients) { const parsedClients = JSON.parse(savedClients); setClients(parsedClients); if (parsedClients.length > 0) { setSelectedClientId(parsedClients[0].id); if (parsedClients[0].scripts.length > 0) setSelectedScriptId(parsedClients[0].scripts[0].id); } } else { const newClient = createNewClient("預設客戶"); setClients([newClient]); setSelectedClientId(newClient.id); setSelectedScriptId(newClient.scripts[0].id); }
            }, []);

            useEffect(() => { if (clients.length > 0) localStorage.setItem(STORAGE_KEY, JSON.stringify(clients)); }, [clients]);
            useEffect(() => { localStorage.setItem(OPTIONS_KEY, JSON.stringify(customOptions)); }, [customOptions]);

            useEffect(() => {
                if (selectedClientId) {
                    const client = clients.find(c => c.id === selectedClientId);
                    if (client && client.scripts.length > 0) { if (!client.scripts.some(s => s.id === selectedScriptId)) setSelectedScriptId(client.scripts[0].id); }
                    setSuggestedTopics([]); setIsSelectionMode(false); setSelectedScriptIds(new Set());
                }
            }, [selectedClientId]);

            const createNewScript = () => {
                const mock = generateMockData('新腳本');
                return {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9), createdAt: Date.now(), scriptConcept: mock.concept, scriptProps: mock.props, scriptModelTips: mock.modelTips,
                    formData: { topic: '', product: '', style: '質感氛圍 (Aesthetic)', duration: '30s', audience: '追求質感的上班族', notes: '' }, scriptData: mock.script
                };
            };

            const createNewClient = (name) => ({ id: Date.now().toString(), name: name, scripts: [createNewScript()] });

            const toggleSelectionMode = () => { setIsSelectionMode(!isSelectionMode); setSelectedScriptIds(new Set()); };
            const toggleScriptSelection = (scriptId) => { const newSet = new Set(selectedScriptIds); newSet.has(scriptId) ? newSet.delete(scriptId) : newSet.add(scriptId); setSelectedScriptIds(newSet); };
            const handleBatchPrint = () => { if (selectedScriptIds.size === 0) { alert("請至少選取一支腳本！"); return; } setIsBatchPrinting(true); setTimeout(() => { window.print(); setIsBatchPrinting(false); }, 500); };
            const handleDownloadAllPDF = () => { const client = clients.find(c => c.id === selectedClientId); if (!client) return; const allIds = new Set(client.scripts.map(s => s.id)); setSelectedScriptIds(allIds); setIsBatchPrinting(true); setTimeout(() => { window.print(); setIsBatchPrinting(false); setSelectedScriptIds(new Set()); }, 500); };
            
            const handleBatchCSV = () => {
                const client = clients.find(c => c.id === selectedClientId);
                if (!client) return;
                let targetScripts = [];
                if (isSelectionMode && selectedScriptIds.size > 0) targetScripts = client.scripts.filter(s => selectedScriptIds.has(s.id));
                else { const current = client.scripts.find(s => s.id === selectedScriptId); if (current) targetScripts = [current]; }
                if (targetScripts.length === 0) { alert("無腳本"); return; }
                const escapeCSV = (text) => `"${String(text || "").replace(/"/g, '""')}"`;
                let csvContent = "\uFEFF";
                csvContent += "腳本主題,影片概念,拍攝道具,模特兒提示,受眾,風格,產品/服務,段落,畫面重點,參考語句\n";
                targetScripts.forEach((script, idx) => {
                    const commonInfo = `${escapeCSV(script.formData.topic)},${escapeCSV(script.scriptConcept)},${escapeCSV(script.scriptProps)},${escapeCSV(script.scriptModelTips)},${escapeCSV(script.formData.audience)},${escapeCSV(script.formData.style)},${escapeCSV(script.formData.product)}`;
                    script.scriptData.forEach(row => { csvContent += `${commonInfo},${escapeCSV(row.section)},${escapeCSV(row.visual)},${escapeCSV(row.dialogue)}\n`; });
                });
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a'); link.href = url; link.download = `scripts_export.csv`; document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };

            const handleAddOption = (type, value) => {
                if (!value || !value.trim()) { alert("請輸入內容"); return; }
                const newValue = value.trim();
                let exists = false;
                if (type === 'services') exists = [...DEFAULT_SERVICES, ...(customOptions.services||[])].includes(newValue);
                if (type === 'audiences') exists = [...DEFAULT_AUDIENCES, ...(customOptions.audiences||[])].includes(newValue);
                if (type === 'styles') exists = [...DEFAULT_STYLES, ...(customOptions.styles||[])].includes(newValue);
                if (!exists) { setCustomOptions(prev => ({ ...prev, [type]: [...(prev[type]||[]), newValue] })); alert("已新增！"); } else alert("已存在");
            };

            const handleStartAddClient = () => { setIsAddingClient(true); setNewClientName(""); };
            const handleCancelAddClient = () => { setIsAddingClient(false); setNewClientName(""); };
            const handleConfirmAddClient = () => { if (newClientName.trim()) { setClients(prev => [createNewClient(newClientName.trim()), ...prev]); setIsAddingClient(false); setNewClientName(""); } };
            const handleDeleteClient = (e, id) => { e.stopPropagation(); if (window.confirm("確定刪除？")) { const newClients = clients.filter(c => c.id !== id); setClients(newClients); if(newClients.length>0) setSelectedClientId(newClients[0].id); } };
            const handleAddScript = () => setClients(prev => prev.map(c => c.id === selectedClientId ? { ...c, scripts: [...c.scripts, createNewScript()] } : c));
            const handleDeleteScript = (e, sid) => { e.stopPropagation(); if (window.confirm("確定刪除？")) setClients(prev => prev.map(c => c.id === selectedClientId ? { ...c, scripts: c.scripts.filter(s => s.id !== sid).length ? c.scripts.filter(s => s.id !== sid) : [createNewScript()] } : c)); };
            const handleSwitchScript = (sid) => isSelectionMode ? toggleScriptSelection(sid) : setSelectedScriptId(sid);
            const handleSaveKey = (e) => { setApiKey(e.target.value); localStorage.setItem('gemini_api_key', e.target.value); };
            
            const updateCurrentScript = (updater) => setClients(prev => prev.map(c => c.id === selectedClientId ? { ...c, scripts: c.scripts.map(s => s.id === selectedScriptId ? updater(s) : s) } : c));
            const handlePaperChange = (field, value, rowId) => updateCurrentScript(s => rowId !== undefined ? { ...s, scriptData: s.scriptData.map(r => r.id === rowId ? { ...r, [field]: value } : r) } : { ...s, [field]: value });
            const handleDeleteRow = (rowId) => updateCurrentScript(s => ({ ...s, scriptData: s.scriptData.filter(r => r.id !== rowId) }));
            const updateFormData = (field, value) => updateCurrentScript(s => ({ ...s, formData: { ...s.formData, [field]: value } }));
            const handleSelectTopic = (topic) => updateFormData('topic', topic);
            
            // 補回原本漏掉的 handleCopyToClipboard
            const handleCopyToClipboard = () => { const s = getActiveData(); if(!s)return; const t = `主題:${s.formData.topic}\n\n${s.scriptData.map(r=>`${r.section}\t${r.visual}\t${r.dialogue}`).join('\n')}`; navigator.clipboard.writeText(t).then(()=>alert("已複製")); };
            const handleExportBackup = () => { const blob = new Blob([JSON.stringify(clients)], {type:'application/json'}); const url = URL.createObjectURL(blob); const link = document.createElement('a'); link.href = url; link.download = "backup.json"; link.click(); };
            const handleImportBackup = (e) => { const reader = new FileReader(); reader.onload = (ev) => setClients(JSON.parse(ev.target.result)); reader.readAsText(e.target.files[0]); };

            const getActiveData = () => clients.find(c => c.id === selectedClientId)?.scripts.find(s => s.id === selectedScriptId);
            
            const handleGenerateTopics = async () => {
                const active = getActiveData(); if(!active) return;
                setIsGeneratingTopics(true);
                try { const topics = await callGeminiTopicsAPI(apiKey, active.formData); setSuggestedTopics(topics); }
                catch (e) { setApiError(e.message); setSuggestedTopics(generateMockTopics(active.formData.audience)); }
                setIsGeneratingTopics(false);
            };

            const handleGenerate = async () => {
                const active = getActiveData(); if(!active || !active.formData.topic) { alert("請輸入主題"); return; }
                setIsGenerating(true); setApiError(null);
                try {
                    const res = await callGeminiAPI(apiKey, active.formData);
                    updateCurrentScript(s => ({ ...s, scriptData: res.script, scriptConcept: res.concept, scriptProps: res.props, scriptModelTips: res.modelTips }));
                } catch(e) { setApiError(e.message); }
                setIsGenerating(false);
            };

            const handlePrintCurrent = () => { window.focus(); setTimeout(() => window.print(), 100); };
            const handleDownloadImage = () => { if(!scriptRef.current)return; setIsDownloadingImage(true); setIsCapturing(true); setTimeout(() => { window.html2canvas(scriptRef.current, { scale: 2, useCORS: true, backgroundColor: '#ffffff', logging: false, ignoreElements: (el) => el.classList.contains('print:hidden') }).then(canvas => { const link = document.createElement('a'); link.href = canvas.toDataURL("image/png"); link.download = "script.png"; link.click(); setIsDownloadingImage(false); setIsCapturing(false); }); }, 300); };

            const activeClient = clients.find(c => c.id === selectedClientId);
            const activeScript = activeClient?.scripts.find(s => s.id === selectedScriptId) || activeClient?.scripts[0];
            const scriptsToBatchPrint = isBatchPrinting ? (isSelectionMode ? activeClient.scripts.filter(s => selectedScriptIds.has(s.id)) : activeClient.scripts) : [];

            return (
                <div className="flex min-h-screen bg-[#f7f7f5] font-sans">
                    <div className="hidden print:block">
                        {isBatchPrinting && scriptsToBatchPrint.map((script) => (
                            <div key={script.id} className="page-break">
                                <ScriptPaper script={script} isPrinting={true} onChange={()=>{}} onDeleteRow={()=>{}} />
                            </div>
                        ))}
                    </div>

                    <aside className={`w-64 bg-stone-900 text-stone-300 flex-shrink-0 flex flex-col transition-all duration-300 print:hidden ${isSidebarOpen?'translate-x-0':'-translate-x-64 absolute h-full z-50'}`}>
                        <div className="p-4 border-b border-stone-800 flex justify-between items-center"><div className="flex gap-2 text-white font-serif tracking-widest"><FolderOpen size={18}/><span>CLIENTS</span></div><button onClick={handleStartAddClient} className="p-1 hover:bg-stone-800 rounded hover:text-white"><Plus size={18}/></button></div>
                        <div className="flex-1 overflow-y-auto p-2 space-y-1">
                            {isAddingClient && <div className="p-2 bg-stone-800 rounded mb-2"><input autoFocus className="w-full bg-stone-700 text-white text-sm p-1 rounded mb-2" value={newClientName} onChange={e=>setNewClientName(e.target.value)} onKeyDown={e=>e.key==='Enter'&&handleConfirmAddClient()} placeholder="輸入客戶名稱..." /><div className="flex justify-end gap-2"><button onClick={handleCancelAddClient}><X size={14}/></button><button onClick={handleConfirmAddClient} className="text-green-500"><Check size={14}/></button></div></div>}
                            {clients.map(c => <div key={c.id} onClick={() => setSelectedClientId(c.id)} className={`flex justify-between items-center p-3 rounded cursor-pointer ${selectedClientId === c.id ? 'bg-stone-800 text-white' : 'hover:bg-stone-800/50'}`}><div className="flex gap-3 overflow-hidden"><User size={14}/><span className="truncate text-sm">{c.name}</span></div><button onClick={(e)=>handleDeleteClient(e, c.id)} className="opacity-0 group-hover:opacity-100 hover:text-red-400"><Trash2 size={14}/></button></div>)}
                        </div>
                        <div className="p-4 bg-stone-900 border-t border-stone-800 space-y-3">
                            <div className="flex gap-2"><button onClick={handleExportBackup} className="flex-1 py-1.5 text-xs bg-stone-800 hover:bg-stone-700 border border-stone-700 rounded flex justify-center gap-1"><Download size={12}/> 匯出</button><label className="flex-1 py-1.5 text-xs bg-stone-800 hover:bg-stone-700 border border-stone-700 rounded flex justify-center gap-1 cursor-pointer"><Upload size={12}/> 匯入<input type="file" accept=".json" onChange={handleImportBackup} className="hidden"/></label></div>
                            <button onClick={() => setShowSettings(!showSettings)} className="flex items-center gap-2 text-xs w-full hover:text-white"><Settings size={14}/> 設定 API Key</button>
                            {showSettings && <div className="mt-2"><input type="password" value={apiKey} onChange={handleSaveKey} placeholder="貼上 API Key..." className="w-full bg-stone-800 border border-stone-700 rounded p-2 text-xs mb-1"/><div className="text-[10px]">自動儲存</div></div>}
                        </div>
                    </aside>

                    <main className={`flex-1 flex flex-col h-screen overflow-hidden transition-all duration-300 ${isSidebarOpen?'':'ml-0'} ${isBatchPrinting?'hidden':''}`}>
                        <header className="h-16 bg-white border-b border-stone-200 flex items-center justify-between px-6 print:hidden">
                            <div className="flex items-center gap-4">
                                <button onClick={()=>setIsSidebarOpen(!isSidebarOpen)}><Scissors size={20}/></button>
                                <div>
                                    <h1 className="font-serif font-bold text-xl text-black flex items-center gap-2">
                                        {activeClient?.name} 的腳本
                                        <button onClick={toggleSelectionMode} className={`ml-3 text-xs px-2 py-1 rounded border flex gap-1 ${isSelectionMode?'bg-indigo-100 text-indigo-700 border-indigo-300':'bg-stone-50 text-stone-500'}`}>{isSelectionMode?<CheckSquare size={14}/>:<Square size={14}/>} 多選</button>
                                        {activeClient && !isSelectionMode && (
                                            <button onClick={handleDownloadAllPDF} className="ml-2 text-xs bg-red-50 hover:bg-red-100 text-red-600 border border-red-200 px-2 py-1 rounded flex items-center gap-1 transition-colors shadow-sm">
                                                <FileIcon size={12} /> 下載全集 PDF
                                            </button>
                                        )}
                                        {isSelectionMode && selectedScriptIds.size > 0 && <button onClick={handleBatchPrint} className="text-xs bg-indigo-600 text-white px-3 py-1 rounded flex gap-1"><Printer size={12}/> 下載選取 PDF ({selectedScriptIds.size})</button>}
                                    </h1>
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={handleBatchCSV} className="flex items-center gap-2 px-3 py-2 bg-stone-100 text-green-700 text-sm font-bold rounded hover:bg-stone-200"><FileSpreadsheet size={16}/><span className="hidden lg:inline">{isSelectionMode ? `選取 CSV` : `下載 CSV`}</span></button>
                                <button onClick={handleCopyToClipboard} className="hidden md:flex items-center gap-2 px-3 py-2 bg-stone-100 text-black text-sm font-bold rounded hover:bg-stone-200"><Table size={16}/><span className="hidden lg:inline">複製表格</span></button>
                                <button onClick={handlePrintCurrent} className="flex items-center gap-2 px-3 py-2 bg-stone-100 text-black text-sm font-bold rounded hover:bg-stone-200"><Printer size={16}/><span className="hidden lg:inline">單頁 PDF</span></button>
                                <button onClick={handleDownloadImage} disabled={isDownloadingImage} className="flex items-center gap-2 px-4 py-2 bg-stone-800 text-white text-sm font-bold rounded hover:bg-stone-700">{isDownloadingImage ? <RefreshCcw size={16} className="animate-spin"/> : <ImageIcon size={16}/>}<span className="hidden sm:inline">下載圖片</span></button>
                            </div>
                        </header>

                        <div className="flex-1 overflow-y-auto bg-[#f7f7f5] print:p-0 print:bg-white print:overflow-visible flex flex-col">
                            {activeClient && (
                                <div className="px-6 md:px-10 pt-6 print:hidden w-full sticky top-0 z-20 bg-[#f7f7f5]">
                                    <div className="flex flex-nowrap items-end gap-2 overflow-x-auto pb-0 w-full custom-scrollbar" style={{minHeight:'60px'}}>
                                        {activeClient.scripts.map((s, i) => (
                                            <div key={s.id} onClick={() => handleSwitchScript(s.id)} className={`flex-shrink-0 px-4 py-2 rounded-t-lg border-t border-x cursor-pointer min-w-[120px] relative group mb-0 ${isSelectionMode && selectedScriptIds.has(s.id) ? 'bg-indigo-50 border-indigo-300' : (selectedScriptId === s.id && !isSelectionMode ? 'bg-white border-stone-300 shadow-sm z-10 border-b-0' : 'bg-stone-100 border-stone-200 text-stone-500 hover:bg-stone-200')}`}>
                                                <div className="flex justify-between"><div className="text-[10px] font-bold opacity-70">#{i+1}</div>{isSelectionMode && <div className={`w-3 h-3 border rounded-sm ${selectedScriptIds.has(s.id)?'bg-indigo-600 border-indigo-600':''}`}/>}</div>
                                                <div className="text-xs font-bold truncate pr-4">{s.formData.topic||"未命名"}</div>
                                                {!isSelectionMode && <button onClick={(e)=>handleDeleteScript(e, s.id)} className="absolute right-1 top-2 opacity-0 group-hover:opacity-100 hover:text-red-500"><X size={12}/></button>}
                                            </div>
                                        ))}
                                        <button onClick={handleAddScript} className="w-8 h-8 rounded-full bg-stone-200 flex items-center justify-center hover:bg-stone-300 mb-1"><Plus size={16}/></button>
                                    </div>
                                    <div className="h-px bg-stone-300 w-full relative z-0"></div>
                                </div>
                            )}

                            <div className="p-6 md:p-10 pt-6 print:p-0">
                                {activeScript && (
                                    <div className="max-w-[297mm] mx-auto mb-8 bg-white p-6 rounded-b-lg shadow-sm print:hidden grid grid-cols-1 md:grid-cols-4 gap-6 animate-in fade-in slide-in-from-top-2">
                                        <div className="md:col-span-3 grid sm:grid-cols-2 gap-x-6 gap-y-4">
                                            <div className="sm:col-span-2">
                                                <div className="flex justify-between mb-1"><label className="text-sm font-bold uppercase">主題</label><button onClick={handleGenerateTopics} disabled={isGeneratingTopics} className="text-[10px] flex items-center gap-1 text-amber-600 bg-amber-50 px-2 py-0.5 rounded">{isGeneratingTopics?<RefreshCcw size={10} className="animate-spin"/>:<Lightbulb size={10}/>} AI 靈感</button></div>
                                                <input value={activeScript.formData.topic} onChange={e=>handleSelectTopic(e.target.value)} className="w-full border-b-2 border-stone-300 py-2 text-base font-bold focus:outline-none focus:border-black" placeholder="輸入主題..." />
                                                {suggestedTopics.length > 0 && <div className="mt-2 flex gap-2">{suggestedTopics.map((t,i)=><button key={i} onClick={()=>handleSelectTopic(t)} className="text-xs bg-stone-100 px-3 py-1 rounded-full">{t}</button>)}</div>}
                                            </div>
                                            <CreatableSelect label="受眾" icon={User} value={activeScript.formData.audience} onChange={v=>updateFormData('audience',v)} onAdd={v=>handleAddOption('audiences',v)} listId="audience-list" options={[...DEFAULT_AUDIENCES, ...(customOptions.audiences||[])]} />
                                            <CreatableSelect label="風格" icon={Palette} value={activeScript.formData.style} onChange={v=>updateFormData('style',v)} onAdd={v=>handleAddOption('styles',v)} listId="style-list" options={[...DEFAULT_STYLES, ...(customOptions.styles||[])]} />
                                            <CreatableSelect label="產品" icon={Briefcase} value={activeScript.formData.product} onChange={v=>updateFormData('product',v)} onAdd={v=>handleAddOption('services',v)} listId="service-list" options={[...DEFAULT_SERVICES, ...(customOptions.services||[])]} />
                                            <div><label className="text-sm font-bold uppercase block mb-1">備註</label><input value={activeScript.formData.notes} onChange={e=>updateFormData('notes',e.target.value)} className="w-full border-b-2 border-stone-300 py-1.5 text-base focus:outline-none focus:border-black"/></div>
                                        </div>
                                        <div className="flex flex-col gap-2"><button onClick={handleGenerate} disabled={isGenerating} className="w-full py-3 bg-stone-800 text-white font-bold rounded shadow-lg hover:bg-stone-700">{isGenerating?<RefreshCcw className="animate-spin"/>:<Sparkles/>} 生成腳本</button></div>
                                    </div>
                                )}

                                {apiError && <div className="max-w-[297mm] mx-auto mb-4 p-3 bg-red-50 text-red-600 text-xs rounded print:hidden">{apiError}</div>}

                                {activeScript && (
                                    <div ref={scriptRef} className="capture-target">
                                        <ScriptPaper script={activeScript} isPrinting={isCapturing} onChange={handlePaperChange} onDeleteRow={handleDeleteRow} />
                                    </div>
                                )}
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
