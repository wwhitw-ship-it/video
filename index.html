<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScriptFlow - Hair Stylist Edition</title>
    
    <!-- 1. 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 引入 html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- 3. 引入 Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. 設定 React 環境 -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0"
        }
    }
    </script>

    <style>
        /* 字體優化 */
        body { font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif; }

        @media print {
            @page { size: landscape; margin: 10mm; }
            body { background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            
            /* 隱藏所有介面元素 */
            .print\:hidden { display: none !important; }
            
            /* 顯示列印專用區塊 */
            .print\:block { display: block !important; }
            
            /* 移除陰影和邊框 */
            .print\:shadow-none { box-shadow: none !important; }
            .print\:border-none { border: none !important; }
            .print\:w-full { width: 100% !important; max-width: none !important; }
            
            /* 強制分頁設定 */
            .page-break { break-after: page; page-break-after: always; }
            tr { break-inside: avoid; }
            
            /* 確保列印時文字自動換行且不被截斷 */
            .force-wrap {
                white-space: pre-wrap;
                word-wrap: break-word;
                overflow-wrap: break-word;
            }
            
            /* 隱藏捲軸 */
            ::-webkit-scrollbar { display: none; }
        }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        .custom-scrollbar::-webkit-scrollbar { height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .capture-target { background-color: white; }
    </style>
</head>
<body class="bg-slate-50 text-black">
    
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Printer, RefreshCcw, Sparkles, Scissors, Settings, Key, AlertCircle, 
            Plus, Trash2, User, Save, FolderOpen, X, Lightbulb, Check, FileText, 
            Copy, Layout, Download, Image as ImageIcon, Briefcase, Smile, Palette,
            Table, Upload, CheckSquare, Square
        } from 'lucide-react';

        // -----------------------------------------------------------------------------
        // 常數定義
        // -----------------------------------------------------------------------------
        const STORAGE_KEY = 'hair_scripts_v3_full'; 
        const OPTIONS_KEY = 'hair_scripts_options';   

        const DEFAULT_SERVICES = [
            "專業剪髮 (Cut)", "韓系燙髮 (Perm)", "縮毛矯正 (Rebonding)", 
            "質感單色染 (Color)", "歐美手刷染 (Balayage)", "光線染/耳圈染 (Highlight)", 
            "深層結構護髮 (Treatment)", "頭皮檢測護理 (Scalp)", 
            "男士油頭/造型 (Barber)", "婚禮/活動造型 (Styling)"
        ];

        const DEFAULT_AUDIENCES = [
            "追求質感的上班族", "預算有限的學生族群", "細軟扁塌髮困擾者", 
            "自然捲/毛躁髮困擾者", "極度受損髮/漂髮客群", "產後落髮/頭皮敏感者", 
            "白髮遮蓋/熟齡客群", "注重門面的商務男士", "韓系風格愛好者", 
            "特殊色/歐美挑染控", "忙碌沒空打理的媽媽", "短髮控/想剪短的女生"
        ];

        const DEFAULT_STYLES = [
            "質感氛圍 (Aesthetic)", "專業教學 (Tutorial)", "日常紀錄 (Vlog)", 
            "幽默短劇 (Funny)", "改造前後 (Before/After)", "ASMR/療癒過程", 
            "避雷/迷思破解", "快速問答 (Q&A)"
        ];

        // -----------------------------------------------------------------------------
        // 獨立元件：可新增選項的下拉選單
        // -----------------------------------------------------------------------------
        const CreatableSelect = ({ label, icon: Icon, value, onChange, onAdd, listId, options }) => {
            return (
                <div>
                    <label className="text-sm font-bold text-black uppercase tracking-wider block mb-1 flex items-center">
                        {Icon && <Icon size={14} className="mr-1" />} {label}
                    </label>
                    <div className="flex gap-2 relative">
                        <input 
                            type="text" 
                            list={listId} 
                            value={value || ''} 
                            onChange={(e) => onChange(e.target.value)} 
                            className="w-full border-b-2 border-stone-300 py-1.5 text-base text-black focus:outline-none focus:border-black bg-transparent placeholder-stone-400"
                            placeholder={`選擇或輸入...`}
                        />
                        <button 
                            type="button"
                            onClick={() => onAdd(value)}
                            className="p-2 bg-stone-200 hover:bg-stone-300 hover:text-black rounded text-stone-700 transition-colors flex-shrink-0 cursor-pointer z-10"
                            title="新增至常用清單"
                        >
                            <Plus size={18} />
                        </button>
                    </div>
                    <datalist id={listId}>
                        {options.map((opt, idx) => <option key={idx} value={opt} />)}
                    </datalist>
                </div>
            );
        };

        // -----------------------------------------------------------------------------
        // 獨立元件：腳本預覽紙張 (用於編輯和批量列印)
        // -----------------------------------------------------------------------------
        const ScriptPaper = ({ script, isPrinting = false, onChange, onDeleteRow }) => {
            if (!script) return null;

            // 根據是否列印模式，決定輸入框是否唯讀/顯示為純文字
            const InputComponent = ({ value, onUpdate, className, placeholder, multiline = false }) => {
                if (isPrinting) {
                    return <div className={`force-wrap ${className}`}>{value}</div>;
                }
                if (multiline) {
                    return (
                        <textarea 
                            value={value || ""} 
                            onChange={(e) => onUpdate(e.target.value)} 
                            className={`${className} focus:outline-none focus:bg-stone-100 resize-none bg-transparent`}
                            placeholder={placeholder}
                        />
                    );
                }
                return (
                    <input 
                        value={value || ""} 
                        onChange={(e) => onUpdate(e.target.value)} 
                        className={`${className} focus:outline-none focus:border-black bg-transparent`}
                        placeholder={placeholder}
                    />
                );
            };

            return (
                <div className={`bg-white max-w-[297mm] mx-auto p-[15mm] shadow-lg print:shadow-none print:w-full print:max-w-none print:p-0 print:m-0 flex flex-col ${!isPrinting ? 'animate-in fade-in zoom-in-95 duration-300' : ''}`}>
                    {/* Header */}
                    <div className="flex justify-between items-end border-b-4 border-stone-800 pb-4 mb-6">
                        <div>
                            <h2 className="text-4xl font-serif font-black text-black">{script.formData.topic || '未命名主題'}</h2>
                            <div className="text-sm text-stone-600 mt-3 font-bold flex gap-2">
                                <span className="bg-stone-100 px-2 py-0.5 rounded">Target: {script.formData.audience}</span>
                                {script.formData.product && <span className="bg-stone-100 px-2 py-0.5 rounded">Item: {script.formData.product}</span>}
                                <span className="bg-stone-100 px-2 py-0.5 rounded">Time: {script.formData.duration}</span>
                            </div>
                        </div>
                        <div className="text-right">
                            <div className="text-sm font-bold text-stone-400 uppercase tracking-widest">Hair Script</div>
                            <div className="text-sm text-stone-400 font-medium">{new Date().toLocaleDateString()}</div>
                        </div>
                    </div>

                    <div className="flex flex-col gap-6">
                        {/* Concept */}
                        <div className="p-5 bg-stone-100 border-l-4 border-stone-400 rounded-r-md print:border-none print:p-0 print:bg-transparent">
                            <div className="flex items-center gap-2 mb-2 text-black"><FileText size={16} /><span className="text-sm font-bold uppercase tracking-wider">影片概念簡述 (Concept)</span></div>
                            <InputComponent 
                                multiline 
                                value={script.scriptConcept} 
                                onUpdate={(v) => onChange('scriptConcept', v)}
                                className="w-full text-lg leading-relaxed text-black font-medium"
                                placeholder="AI 生成的影片概念..."
                            />
                        </div>

                        {/* Table */}
                        <div className="border-2 border-stone-300 flex-1 print:border-none">
                            <table className="w-full border-collapse table-fixed">
                                <thead>
                                    <tr className="bg-stone-200 text-black">
                                        <th className="w-[8%] py-3 border-r-2 border-stone-300 text-sm font-bold text-center">段落</th>
                                        <th className="w-[46%] py-3 border-r-2 border-stone-300 text-sm font-bold text-center">大綱重點 (Outline)</th>
                                        <th className="w-[46%] py-3 text-sm font-bold text-center">參考語句 (Ref)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {script.scriptData.map((row) => (
                                        <tr key={row.id} className="border-t-2 border-stone-300 group hover:bg-stone-50 transition-colors">
                                            <td className="p-3 border-r-2 border-stone-300 text-center align-middle relative bg-stone-50">
                                                <InputComponent 
                                                    value={row.section} 
                                                    onUpdate={(v) => onChange('section', v, row.id)}
                                                    className="font-serif text-lg font-black text-black w-full text-center mb-0.5"
                                                />
                                                {!isPrinting && (
                                                    <button onClick={() => onDeleteRow(row.id)} className="absolute left-1 top-1 text-stone-300 hover:text-red-400 opacity-0 group-hover:opacity-100 print:hidden"><Trash2 size={12} /></button>
                                                )}
                                            </td>
                                            <td className="p-0 border-r-2 border-stone-300 align-top relative">
                                                <InputComponent 
                                                    multiline
                                                    value={row.visual}
                                                    onUpdate={(v) => onChange('visual', v, row.id)}
                                                    className="w-full h-32 p-4 text-xl leading-relaxed text-black font-medium"
                                                    placeholder="輸入重點..."
                                                />
                                            </td>
                                            <td className="p-0 align-top relative">
                                                <InputComponent 
                                                    multiline
                                                    value={row.dialogue}
                                                    onUpdate={(v) => onChange('dialogue', v, row.id)}
                                                    className="w-full h-32 p-4 text-xl leading-relaxed text-black font-medium"
                                                    placeholder="輸入台詞..."
                                                />
                                            </td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>

                        {/* Props & Model Tips */}
                        <div className="grid grid-cols-2 gap-8 mt-2 pt-4 border-t-2 border-stone-200">
                            <div>
                                <div className="flex items-center gap-2 mb-2 text-black"><Briefcase size={16} /><span className="text-sm font-bold uppercase tracking-wider">拍攝道具 (Props)</span></div>
                                <InputComponent 
                                    multiline
                                    value={script.scriptProps}
                                    onUpdate={(v) => onChange('scriptProps', v)}
                                    className="w-full text-base text-black font-medium"
                                    placeholder="需要的道具..."
                                />
                            </div>
                            <div>
                                <div className="flex items-center gap-2 mb-2 text-black"><Smile size={16} /><span className="text-sm font-bold uppercase tracking-wider">模特兒提示 (Model)</span></div>
                                <InputComponent 
                                    multiline
                                    value={script.scriptModelTips}
                                    onUpdate={(v) => onChange('scriptModelTips', v)}
                                    className="w-full text-base text-black font-medium"
                                    placeholder="模特兒條件..."
                                />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // -----------------------------------------------------------------------------
        // 模擬 AI 邏輯
        // -----------------------------------------------------------------------------
        const generateMockData = (topic) => {
            return {
                concept: `這是一支以「${topic || '未命名'}」為主題的短片，透過設計師親自示範，展現專業與親切感。`,
                props: "尖尾梳、圓梳、定型液、吹風機",
                modelTips: "髮長過肩，有些微自然捲，髮色偏淺尤佳。",
                script: [
                    { id: 1, section: "起", visual: "設計師對著鏡頭做出『母湯』的手勢。", dialogue: "你是那種洗完頭直接包著毛巾一小時的人嗎？" },
                    { id: 2, section: "承", visual: "快速示範錯誤 vs 正確的吹整手勢。", dialogue: "這樣包只會讓頭皮悶住發臭，髮根還會塌到貼頭皮。" },
                    { id: 3, section: "轉", visual: "展示吹乾後的蓬鬆髮根特寫。", dialogue: "其實只要洗完立刻逆向吹乾，蓬鬆度直接撐一整天。" },
                    { id: 4, section: "合", visual: "設計師笑著指下方資訊欄。", dialogue: "想知道你的髮質適合哪種護髮？留言『想知道』告訴你！" }
                ]
            };
        };

        const generateMockTopics = (audience) => [
            `3分鐘快速出門造型`, `顯白髮色推薦 Top3`, `不用燙的蓬鬆技巧`
        ];

        // -----------------------------------------------------------------------------
        // API 呼叫邏輯
        // -----------------------------------------------------------------------------
        const callGeminiAPI = async (apiKey, formData) => {
            const prompt = `
                你是一個專業的美髮短影音腳本企劃。請根據以下資訊生成腳本：
                - 主題：${formData.topic}
                - 產品/服務：${formData.product || '無特定'} 
                - 風格：${formData.style} 
                - 受眾：${formData.audience}
                - 補充重點：${formData.notes || '無'} 
                - 時長：${formData.duration}

                【任務要求】
                1. **影片概念簡述 (Concept)**：請用一句話說明這支影片的主旨。
                2. **準備道具 (Props)**：列出拍攝這支影片需要準備的工具或產品（如：圓梳、某牌髮油）。
                3. **模特兒提示 (Model Tips)**：建議模特兒的髮況條件（如：需有布丁頭、細軟髮）。
                4. **大綱重點 (Outline)**：不要複雜的運鏡，只要寫「畫面重點」或「動作指示」，簡潔有力。
                5. **參考語句 (Dialogue)**：設計師的口語台詞，重點就好，控制在 2-3 句以內。

                請回傳純 JSON 物件 (Object)，格式如下：
                {
                "concept": "影片概念簡述...",
                "props": "所需道具...",
                "modelTips": "模特兒條件...",
                "script": [
                    { "section": "起", "visual": "簡潔的畫面重點", "dialogue": "口語參考台詞" },
                    { "section": "承", "visual": "簡潔的畫面重點", "dialogue": "口語參考台詞" },
                    ...
                ]
                }
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-001:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                const data = await response.json();
                if (data.error) throw new Error(data.error.message || "API 連線錯誤");
                if (!data.candidates || !data.candidates[0].content) throw new Error("無內容回傳，請檢查 API Key 額度或權限。");

                let text = data.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim();
                const parsed = JSON.parse(text);
                
                const scriptWithIds = parsed.script.map((item, index) => ({ 
                    ...item, 
                    id: Date.now() + index, 
                    section: item.section ? item.section.substring(0, 1) : "段"
                }));

                return { 
                    concept: parsed.concept || "無概念描述", 
                    props: parsed.props || "",
                    modelTips: parsed.modelTips || "",
                    script: scriptWithIds 
                };
            } catch (error) {
                console.error("Gemini API Error:", error);
                throw error;
            }
        };

        const callGeminiTopicsAPI = async (apiKey, formData) => {
            const prompt = `
                你是一個美髮社群小編。請根據以下條件提供 3 個吸睛的 IG Reels 短影音主題標題：
                - 產品/服務：${formData.product || '一般剪燙染'}
                - 目標受眾：${formData.audience}
                - 補充重點：${formData.notes || '無'}
                - 風格：${formData.style}
                **重要：標題必須非常精簡、短促有力（10個字以內），像 IG Reels 的封面標題那樣。**
                請直接回傳一個純 JSON 字串陣列，例如：["顯白髮色Top3", "3分鐘快速出門"]
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-001:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                let text = data.candidates[0].content.parts[0].text.replace(/```json/g, '').replace(/```/g, '').trim();
                return JSON.parse(text);
            } catch (error) {
                console.error("Gemini Topics API Error:", error);
                throw error;
            }
        };

        // -----------------------------------------------------------------------------
        // React App Component
        // -----------------------------------------------------------------------------
        function App() {
            // 資料狀態
            const [clients, setClients] = useState([]);
            const [customOptions, setCustomOptions] = useState({
                services: [], audiences: [], styles: []
            });

            // UI 狀態
            const [selectedClientId, setSelectedClientId] = useState(null);
            const [selectedScriptId, setSelectedScriptId] = useState(null);
            
            // 多選模式狀態 (Batch Selection)
            const [isSelectionMode, setIsSelectionMode] = useState(false);
            const [selectedScriptIds, setSelectedScriptIds] = useState(new Set());
            const [isBatchPrinting, setIsBatchPrinting] = useState(false); // 用於控制渲染列印畫面

            const [isAddingClient, setIsAddingClient] = useState(false);
            const [newClientName, setNewClientName] = useState("");
            const [isGenerating, setIsGenerating] = useState(false);
            const [isGeneratingTopics, setIsGeneratingTopics] = useState(false);
            const [suggestedTopics, setSuggestedTopics] = useState([]);
            const [apiKey, setApiKey] = useState('');
            const [showSettings, setShowSettings] = useState(false);
            const [apiError, setApiError] = useState(null);
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            const [isDownloadingImage, setIsDownloadingImage] = useState(false);
            const [isCapturing, setIsCapturing] = useState(false); 
            
            const scriptRef = useRef(null);

            // 初始化
            useEffect(() => {
                const savedApiKey = localStorage.getItem('gemini_api_key');
                if (savedApiKey) setApiKey(savedApiKey);

                const savedOptions = localStorage.getItem(OPTIONS_KEY);
                if (savedOptions) setCustomOptions(JSON.parse(savedOptions));

                const savedClients = localStorage.getItem(STORAGE_KEY);
                if (savedClients) {
                    const parsedClients = JSON.parse(savedClients);
                    setClients(parsedClients);
                    if (parsedClients.length > 0) {
                        setSelectedClientId(parsedClients[0].id);
                        if (parsedClients[0].scripts && parsedClients[0].scripts.length > 0) {
                            setSelectedScriptId(parsedClients[0].scripts[0].id);
                        }
                    }
                } else {
                    const newClient = createNewClient("預設客戶");
                    setClients([newClient]);
                    setSelectedClientId(newClient.id);
                    setSelectedScriptId(newClient.scripts[0].id);
                }
            }, []);

            // 儲存資料
            useEffect(() => {
                if (clients.length > 0) localStorage.setItem(STORAGE_KEY, JSON.stringify(clients));
            }, [clients]);

            useEffect(() => {
                localStorage.setItem(OPTIONS_KEY, JSON.stringify(customOptions));
            }, [customOptions]);

            // 當切換客戶時，重置選取狀態
            useEffect(() => {
                if (selectedClientId) {
                    const client = clients.find(c => c.id === selectedClientId);
                    if (client && client.scripts.length > 0) {
                        const currentScriptExists = client.scripts.some(s => s.id === selectedScriptId);
                        if (!currentScriptExists) setSelectedScriptId(client.scripts[0].id);
                    }
                    setSuggestedTopics([]);
                    setIsSelectionMode(false);
                    setSelectedScriptIds(new Set());
                }
            }, [selectedClientId]);

            const createNewScript = () => {
                const mock = generateMockData('新腳本');
                return {
                    id: Date.now().toString() + Math.random().toString(36).substr(2, 9),
                    createdAt: Date.now(),
                    scriptConcept: mock.concept,
                    scriptProps: mock.props,
                    scriptModelTips: mock.modelTips,
                    formData: {
                        topic: '', product: '', style: '質感氛圍 (Aesthetic)', duration: '30s', audience: '追求質感的上班族', notes: ''
                    },
                    scriptData: mock.script
                };
            };

            const createNewClient = (name) => ({
                id: Date.now().toString(),
                name: name,
                scripts: [createNewScript()]
            });

            // --- Handlers: Multi-Select & Batch Print ---
            const toggleSelectionMode = () => {
                setIsSelectionMode(!isSelectionMode);
                setSelectedScriptIds(new Set()); // 切換模式時清空選取
            };

            const toggleScriptSelection = (scriptId) => {
                const newSet = new Set(selectedScriptIds);
                if (newSet.has(scriptId)) {
                    newSet.delete(scriptId);
                } else {
                    newSet.add(scriptId);
                }
                setSelectedScriptIds(newSet);
            };

            const handleBatchPrint = () => {
                if (selectedScriptIds.size === 0) {
                    alert("請至少選取一支腳本！");
                    return;
                }
                setIsBatchPrinting(true); // 啟動渲染列印區塊
                // 延遲觸發列印，等待 DOM 渲染
                setTimeout(() => {
                    window.print();
                    // 列印對話框關閉後，這裡的程式碼可能會立即執行，
                    // 但為了安全起見，我們可以讓使用者手動關閉或延遲關閉，
                    // 這裡設定為自動還原
                    setIsBatchPrinting(false);
                }, 500);
            };

            // --- Handlers: Data & Logic ---
            const handleAddOption = (type, value) => {
                if (!value || value.trim() === "") { alert("請先輸入內容再新增喔！"); return; }
                const newValue = value.trim();
                let exists = false;
                if (type === 'services') exists = [...DEFAULT_SERVICES, ...customOptions.services].includes(newValue);
                if (type === 'audiences') exists = [...DEFAULT_AUDIENCES, ...customOptions.audiences].includes(newValue);
                if (type === 'styles') exists = [...DEFAULT_STYLES, ...customOptions.styles].includes(newValue);

                if (!exists) {
                    setCustomOptions(prev => ({ ...prev, [type]: [...prev[type], newValue] }));
                    alert(`成功！已將「${newValue}」加入常用選單。`);
                } else {
                    alert("這個選項已經在清單裡囉！");
                }
            };

            const handleStartAddClient = () => { setIsAddingClient(true); setNewClientName(""); };
            const handleCancelAddClient = () => { setIsAddingClient(false); setNewClientName(""); };
            const handleConfirmAddClient = () => {
                if (newClientName.trim()) {
                    const newClient = createNewClient(newClientName.trim());
                    setClients(prev => [newClient, ...prev]);
                    setSelectedClientId(newClient.id);
                    setSelectedScriptId(newClient.scripts[0].id);
                    setIsAddingClient(false);
                    setNewClientName("");
                }
            };
            const handleDeleteClient = (e, id) => {
                e.stopPropagation();
                if (window.confirm("確定要刪除這位客戶以及他的所有腳本嗎？")) {
                    const newClients = clients.filter(c => c.id !== id);
                    setClients(newClients);
                    if (newClients.length > 0) {
                        setSelectedClientId(newClients[0].id);
                        setSelectedScriptId(newClients[0].scripts[0]?.id);
                    } else {
                        const defaultClient = createNewClient("新客戶");
                        setClients([defaultClient]);
                        setSelectedClientId(defaultClient.id);
                        setSelectedScriptId(defaultClient.scripts[0].id);
                    }
                }
            };

            const handleAddScript = () => {
                setClients(prev => prev.map(c => {
                    if (c.id === selectedClientId) {
                        return { ...c, scripts: [...c.scripts, createNewScript()] };
                    }
                    return c;
                }));
            };
            const handleDeleteScript = (e, scriptId) => {
                e.stopPropagation();
                if (window.confirm("確定要刪除這支腳本嗎？")) {
                    setClients(prev => prev.map(c => {
                        if (c.id === selectedClientId) {
                            const newScripts = c.scripts.filter(s => s.id !== scriptId);
                            if (newScripts.length === 0) newScripts.push(createNewScript());
                            return { ...c, scripts: newScripts };
                        }
                        return c;
                    }));
                }
            };
            const handleSwitchScript = (scriptId) => {
                if (isSelectionMode) {
                    toggleScriptSelection(scriptId);
                } else {
                    setSelectedScriptId(scriptId);
                }
            };
            
            const handleSaveKey = (e) => { setApiKey(e.target.value); localStorage.setItem('gemini_api_key', e.target.value); };

            // Update logic helper - handles both root fields and form data
            const updateCurrentScript = (updater) => {
                setClients(prev => prev.map(c => {
                    if (c.id === selectedClientId) {
                        const updatedScripts = c.scripts.map(s => {
                            if (s.id === selectedScriptId) return updater(s);
                            return s;
                        });
                        return { ...c, scripts: updatedScripts };
                    }
                    return c;
                }));
            };

            // Specific update handlers passing to ScriptPaper
            const handlePaperChange = (field, value, rowId) => {
                updateCurrentScript(s => {
                    // Handle array updates (scriptData rows)
                    if (rowId !== undefined) {
                        return {
                            ...s,
                            scriptData: s.scriptData.map(r => r.id === rowId ? { ...r, [field]: value } : r)
                        };
                    }
                    // Handle root level fields (concept, props, modelTips)
                    if (['scriptConcept', 'scriptProps', 'scriptModelTips'].includes(field)) {
                        return { ...s, [field]: value };
                    }
                    // Handle root level scriptData (e.g. delete) - handled separately below usually
                    return s;
                });
            };
            
            const handleDeleteRow = (rowId) => updateCurrentScript(s => ({
                ...s, scriptData: s.scriptData.filter(r => r.id !== rowId)
            }));

            const updateFormData = (field, value) => updateCurrentScript(s => ({ ...s, formData: { ...s.formData, [field]: value } }));
            const handleSelectTopic = (topic) => updateFormData('topic', topic);

            // --- Generation & Download ---
            const getActiveData = () => {
                const client = clients.find(c => c.id === selectedClientId);
                if (!client) return null;
                return client.scripts.find(s => s.id === selectedScriptId);
            };

            const handleGenerateTopics = async () => {
                const activeScript = getActiveData();
                if (!activeScript) return;
                setIsGeneratingTopics(true);
                setSuggestedTopics([]);
                if (apiKey && apiKey.length > 20) {
                    try {
                        const topics = await callGeminiTopicsAPI(apiKey, activeScript.formData);
                        setSuggestedTopics(topics);
                    } catch (error) {
                        setApiError(`主題生成失敗: ${error.message}`);
                        setSuggestedTopics(generateMockTopics(activeScript.formData.audience));
                    }
                } else {
                    setTimeout(() => setSuggestedTopics(generateMockTopics(activeScript.formData.audience)), 500);
                }
                setIsGeneratingTopics(false);
            };

            const handleGenerate = async () => {
                const activeScript = getActiveData();
                if (!activeScript) return;
                if (!activeScript.formData.topic) { alert("請先輸入或選擇一個影片主題！"); return; }
                setIsGenerating(true);
                setApiError(null);
                if (apiKey && apiKey.length > 20) {
                    try {
                        const result = await callGeminiAPI(apiKey, activeScript.formData);
                        updateCurrentScript(s => ({
                            ...s,
                            scriptData: result.script,
                            scriptConcept: result.concept,
                            scriptProps: result.props,
                            scriptModelTips: result.modelTips
                        }));
                    } catch (error) { setApiError(`API 連線失敗: ${error.message}`); }
                } else {
                    setTimeout(() => {
                        const mock = generateMockData(activeScript.formData.topic);
                        updateCurrentScript(s => ({
                            ...s,
                            scriptData: mock.script,
                            scriptConcept: mock.concept,
                            scriptProps: mock.props,
                            scriptModelTips: mock.modelTips
                        }));
                    }, 500);
                }
                setIsGenerating(false);
            };

            const handlePrintCurrent = () => { window.focus(); setTimeout(() => window.print(), 100); };
            
            const handleDownloadImage = () => {
                if (!scriptRef.current) return;
                setIsDownloadingImage(true);
                setIsCapturing(true); 
                setTimeout(() => {
                    window.html2canvas(scriptRef.current, {
                        scale: 2, useCORS: true, backgroundColor: '#ffffff', logging: false,
                        ignoreElements: (element) => element.classList.contains('print:hidden')
                    }).then(canvas => {
                        const image = canvas.toDataURL("image/png");
                        const link = document.createElement('a');
                        link.href = image;
                        link.download = `${getActiveData()?.formData?.topic || 'script'}_腳本.png`;
                        link.click();
                        setIsDownloadingImage(false);
                        setIsCapturing(false);
                    }).catch(err => {
                        console.error(err); alert("圖片生成失敗"); setIsDownloadingImage(false); setIsCapturing(false);
                    });
                }, 300); 
            };

            const handleCopyToClipboard = () => {
                const script = getActiveData();
                if (!script) return;
                const formatCell = (text) => `"${(text || "").replace(/"/g, '""')}"`;
                let text = "段落\t大綱重點\t參考語句\n";
                script.scriptData.forEach(row => { text += `${row.section}\t${formatCell(row.visual)}\t${formatCell(row.dialogue)}\n`; });
                text += `\n項目\t內容\n影片概念\t${formatCell(script.scriptConcept)}\n拍攝道具\t${formatCell(script.scriptProps)}\n模特兒提示\t${formatCell(script.scriptModelTips)}\n主題\t${formatCell(script.formData.topic)}\n`;
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                try { document.execCommand('copy'); alert("已複製！請直接在 Excel 或 Google Sheets 貼上 (Ctrl+V)"); } catch (err) { alert("複製失敗"); }
                document.body.removeChild(textArea);
            };

            const handleExportBackup = () => {
                const data = JSON.stringify(clients, null, 2);
                const blob = new Blob([data], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `scriptflow_backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const handleImportBackup = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (Array.isArray(data)) {
                            if(window.confirm('這將會覆蓋您目前的資料，確定要匯入嗎？')) {
                                setClients(data);
                                alert('資料匯入成功！');
                            }
                        } else { alert('檔案格式錯誤'); }
                    } catch (err) { alert('讀取檔案失敗'); }
                };
                reader.readAsText(file);
            };

            const activeClient = clients.find(c => c.id === selectedClientId);
            const activeScript = activeClient?.scripts.find(s => s.id === selectedScriptId) || activeClient?.scripts[0];

            // Get list of scripts to print
            const scriptsToBatchPrint = isBatchPrinting 
                ? activeClient.scripts.filter(s => selectedScriptIds.has(s.id))
                : [];

            // Render
            return (
                <div className="flex min-h-screen bg-[#f7f7f5] font-sans">
                    {/* 隱藏的列印容器 - 只有在 Batch Print 時才會有內容 */}
                    <div className="hidden print:block">
                        {/* 邏輯：
                           1. 如果是 isBatchPrinting = true，渲染選取的 scripts
                           2. 如果是一般列印 (handlePrintCurrent)，瀏覽器會印出 main 下面的 activeScript (透過 CSS 控制)
                           但是為了簡單起見，我們讓 handlePrintCurrent 印出當前畫面
                           而 Batch Print 時，我們隱藏 root，只顯示這個 container (需調整 CSS)
                        */}
                        {isBatchPrinting && scriptsToBatchPrint.map((script, idx) => (
                            <div key={script.id} className="page-break">
                                <ScriptPaper 
                                    script={script} 
                                    isPrinting={true} 
                                    // Mock handlers for read-only
                                    onChange={()=>{}} 
                                    onDeleteRow={()=>{}} 
                                />
                            </div>
                        ))}
                    </div>

                    {/* 左側邊欄 */}
                    <aside className={`w-64 bg-stone-900 text-stone-300 flex-shrink-0 flex flex-col transition-all duration-300 print:hidden ${isSidebarOpen ? 'translate-x-0' : '-translate-x-64 absolute h-full z-50'}`}>
                        <div className="p-4 border-b border-stone-800 flex items-center justify-between">
                            <div className="flex items-center gap-2 text-white font-serif tracking-widest"><FolderOpen size={18} /><span>CLIENTS</span></div>
                            <button onClick={handleStartAddClient} className="p-1 hover:bg-stone-800 rounded text-stone-400 hover:text-white"><Plus size={18} /></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-2 space-y-1">
                            {isAddingClient && (
                                <div className="p-2 bg-stone-800 rounded-md mb-2 animate-in slide-in-from-left-2">
                                    <input autoFocus type="text" value={newClientName} onChange={(e) => setNewClientName(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleConfirmAddClient()} className="w-full bg-stone-700 text-white text-sm p-1.5 rounded border border-stone-600 focus:outline-none mb-2" placeholder="輸入客戶名稱..." />
                                    <div className="flex justify-end gap-2">
                                        <button onClick={handleCancelAddClient} className="p-1 text-stone-400 hover:text-white"><X size={14}/></button>
                                        <button onClick={handleConfirmAddClient} className="p-1 text-green-500 hover:text-green-400"><Check size={14}/></button>
                                    </div>
                                </div>
                            )}
                            {clients.map(client => (
                                <div key={client.id} onClick={() => setSelectedClientId(client.id)} className={`group flex items-center justify-between p-3 rounded-md cursor-pointer transition-colors ${selectedClientId === client.id ? 'bg-stone-800 text-white' : 'hover:bg-stone-800/50'}`}>
                                    <div className="flex flex-col gap-1 overflow-hidden w-full">
                                        <div className="flex items-center gap-3"><User size={14} className={selectedClientId === client.id ? 'text-stone-300' : 'text-stone-600'} /><span className="truncate text-sm font-medium">{client.name}</span></div>
                                        <div className={`text-[10px] pl-7 ${selectedClientId === client.id ? 'text-stone-400' : 'text-stone-600'}`}>{client.scripts.length} 支腳本</div>
                                    </div>
                                    <button onClick={(e) => handleDeleteClient(e, client.id)} className="opacity-0 group-hover:opacity-100 p-1 hover:text-red-400 text-stone-500"><Trash2 size={14} /></button>
                                </div>
                            ))}
                        </div>
                        <div className="p-4 border-t border-stone-800 bg-stone-900 space-y-3">
                            <div className="flex gap-2">
                                <button onClick={handleExportBackup} className="flex-1 flex items-center justify-center gap-1 py-1.5 text-xs bg-stone-800 hover:bg-stone-700 text-stone-300 rounded border border-stone-700 transition-colors" title="下載所有資料備份"><Download size={12} /> 匯出備份</button>
                                <label className="flex-1 flex items-center justify-center gap-1 py-1.5 text-xs bg-stone-800 hover:bg-stone-700 text-stone-300 rounded border border-stone-700 transition-colors cursor-pointer" title="匯入備份檔案">
                                    <Upload size={12} /> 匯入備份
                                    <input type="file" accept=".json" onChange={handleImportBackup} className="hidden" />
                                </label>
                            </div>
                            <button onClick={() => setShowSettings(!showSettings)} className="flex items-center gap-2 text-xs text-stone-500 hover:text-white w-full"><Settings size={14} /><span>設定 API Key</span></button>
                            {showSettings && (
                                <div className="mt-3 animate-in slide-in-from-bottom-2">
                                    <div className="relative"><Key size={12} className="absolute left-2 top-2.5 text-stone-500" /><input type="password" value={apiKey} onChange={handleSaveKey} placeholder="貼上 API Key..." className="w-full bg-stone-800 border border-stone-700 rounded p-2 pl-7 text-xs text-stone-200 focus:outline-none" /></div>
                                    <div className="text-[10px] text-stone-600 mt-2 flex items-center gap-1"><Save size={10} /> 自動儲存於本機</div>
                                </div>
                            )}
                        </div>
                    </aside>

                    {/* 右側內容 (在 Batch Printing 時隱藏) */}
                    <main className={`flex-1 flex flex-col h-screen overflow-hidden transition-all duration-300 ${isSidebarOpen ? '' : 'ml-0'} ${isBatchPrinting ? 'hidden' : ''}`}>
                        <header className="h-16 bg-white border-b border-stone-200 flex items-center justify-between px-6 flex-shrink-0 print:hidden">
                            <div className="flex items-center gap-4">
                                <button onClick={() => setIsSidebarOpen(!isSidebarOpen)} className="p-2 -ml-2 hover:bg-stone-100 rounded text-stone-500"><Scissors size={20} /></button>
                                <div>
                                    <h1 className="font-serif font-bold text-xl text-black flex items-center gap-2">
                                        {activeClient?.name} 的腳本企劃
                                        {/* 多選模式開關 */}
                                        <button 
                                            onClick={toggleSelectionMode} 
                                            className={`ml-3 text-xs px-2 py-1 rounded flex items-center gap-1 transition-colors border ${isSelectionMode ? 'bg-indigo-100 text-indigo-700 border-indigo-300' : 'bg-stone-50 text-stone-500 border-stone-200'}`}
                                            title="開啟多選以下載多份腳本"
                                        >
                                            {isSelectionMode ? <CheckSquare size={14} /> : <Square size={14} />}
                                            {isSelectionMode ? '多選模式 (開啟)' : '多選模式'}
                                        </button>
                                        {/* 批量下載按鈕 */}
                                        {isSelectionMode && selectedScriptIds.size > 0 && (
                                            <button 
                                                onClick={handleBatchPrint} 
                                                className="text-xs bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1 rounded flex items-center gap-1 shadow-sm animate-in fade-in zoom-in"
                                            >
                                                <Printer size={12} /> 下載選取 PDF ({selectedScriptIds.size})
                                            </button>
                                        )}
                                    </h1>
                                    <div className="text-xs text-stone-500 flex items-center gap-2">{apiKey ? <span className="text-green-600">● AI 連線中</span> : <span>● 模擬模式</span>}</div>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={handleCopyToClipboard} className="hidden md:flex items-center gap-2 px-3 py-2 bg-stone-100 text-black text-sm font-bold rounded hover:bg-stone-200 shadow-sm" title="複製表格"><Table size={16} /><span className="hidden lg:inline">複製表格</span></button>
                                <button onClick={handlePrintCurrent} className="flex items-center gap-2 px-3 py-2 bg-stone-100 text-black text-sm font-bold rounded hover:bg-stone-200 shadow-sm"><Printer size={16} /><span className="hidden lg:inline">單頁 PDF</span></button>
                                <button onClick={handleDownloadImage} disabled={isDownloadingImage} className="flex items-center gap-2 px-4 py-2 bg-stone-800 text-white text-sm font-bold rounded hover:bg-stone-700 shadow-sm">{isDownloadingImage ? <RefreshCcw size={16} className="animate-spin" /> : <ImageIcon size={16} />}<span className="hidden sm:inline">下載圖片</span></button>
                            </div>
                        </header>

                        <div className="flex-1 overflow-y-auto bg-[#f7f7f5] print:p-0 print:bg-white print:overflow-visible flex flex-col">
                            {/* 腳本 Tabs */}
                            {activeClient && (
                                <div className="px-6 md:px-10 pt-6 print:hidden w-full">
                                    <div className="flex flex-nowrap items-center gap-2 overflow-x-auto pb-2 w-full custom-scrollbar">
                                        {activeClient.scripts.map((script, index) => {
                                            const isSelected = selectedScriptIds.has(script.id);
                                            return (
                                                <div 
                                                    key={script.id} 
                                                    onClick={() => handleSwitchScript(script.id)} 
                                                    className={`
                                                        flex-shrink-0 group relative px-4 py-2 rounded-t-lg border-t border-x cursor-pointer transition-all select-none min-w-[120px] max-w-[200px]
                                                        ${isSelectionMode && isSelected ? 'bg-indigo-50 border-indigo-300 ring-1 ring-inset ring-indigo-300' : ''}
                                                        ${selectedScriptId === script.id && !isSelectionMode ? 'bg-white border-stone-300 text-black shadow-sm z-10' : 'bg-stone-100 border-stone-200 text-stone-500 hover:bg-stone-200'}
                                                    `}
                                                >
                                                    <div className="flex justify-between items-start">
                                                        <div className="text-[10px] font-bold uppercase tracking-wider mb-0.5 opacity-70">Script #{index + 1}</div>
                                                        {isSelectionMode && (
                                                            <div className={`w-3 h-3 rounded-sm border ${isSelected ? 'bg-indigo-600 border-indigo-600' : 'border-stone-400 bg-white'}`}>
                                                                {isSelected && <Check size={10} className="text-white" />}
                                                            </div>
                                                        )}
                                                    </div>
                                                    <div className="text-xs font-bold truncate pr-4">{script.formData.topic || "未命名腳本"}</div>
                                                    {!isSelectionMode && (
                                                        <button onClick={(e) => handleDeleteScript(e, script.id)} className={`absolute right-1 top-2 p-1 rounded-full hover:bg-red-100 hover:text-red-500 ${selectedScriptId === script.id ? 'text-stone-400' : 'text-stone-300 opacity-0 group-hover:opacity-100'}`}><X size={12} /></button>
                                                    )}
                                                </div>
                                            );
                                        })}
                                        <button onClick={handleAddScript} className="flex-shrink-0 flex items-center justify-center w-8 h-8 rounded-full bg-stone-200 hover:bg-stone-300 text-stone-500 ml-1"><Plus size={16} /></button>
                                    </div>
                                    <div className="h-px bg-stone-300 -mt-px relative z-0"></div>
                                </div>
                            )}

                            <div className="p-6 md:p-10 pt-4 print:p-0">
                                {/* 輸入區 */}
                                {activeScript && (
                                    <div className="max-w-[297mm] mx-auto mb-8 bg-white p-6 rounded-b-lg rounded-tr-lg shadow-sm border border-t-0 border-stone-200 print:hidden grid grid-cols-1 md:grid-cols-4 gap-6 items-end animate-in fade-in slide-in-from-top-2">
                                        <div className="md:col-span-3 grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-4">
                                            {/* 主題 */}
                                            <div className="sm:col-span-2">
                                                <div className="flex items-center justify-between mb-1"><label className="text-sm font-bold text-black uppercase tracking-wider">主題 Topic</label><button onClick={handleGenerateTopics} disabled={isGeneratingTopics} className="text-[10px] flex items-center gap-1 text-amber-600 hover:text-amber-700 bg-amber-50 hover:bg-amber-100 px-2 py-0.5 rounded">{isGeneratingTopics ? <RefreshCcw size={10} className="animate-spin" /> : <Lightbulb size={10} />}{isGeneratingTopics ? '發想中...' : 'AI 靈感'}</button></div>
                                                <input type="text" value={activeScript.formData.topic} onChange={(e) => handleSelectTopic(e.target.value)} className="w-full border-b-2 border-stone-300 py-2 text-base text-black font-bold focus:outline-none focus:border-black bg-transparent placeholder-stone-400" placeholder="請輸入主題..." />
                                                {suggestedTopics.length > 0 && <div className="mt-3 flex flex-wrap gap-2 animate-in fade-in slide-in-from-top-1">{suggestedTopics.map((topic, idx) => <button key={idx} onClick={() => handleSelectTopic(topic)} className="text-xs bg-stone-100 hover:bg-stone-800 hover:text-white text-stone-600 px-3 py-1.5 rounded-full transition-all border border-stone-200 text-left">{topic}</button>)}</div>}
                                            </div>
                                            
                                            {/* 可新增的選單 */}
                                            <CreatableSelect 
                                                label="受眾 Target" 
                                                icon={User}
                                                value={activeScript.formData.audience} 
                                                onChange={(val) => updateFormData('audience', val)}
                                                onAdd={(val) => handleAddOption('audiences', val)}
                                                listId="audience-list"
                                                options={[...DEFAULT_AUDIENCES, ...customOptions.audiences]}
                                            />

                                            <CreatableSelect 
                                                label="風格 Style" 
                                                icon={Palette}
                                                value={activeScript.formData.style} 
                                                onChange={(val) => updateFormData('style', val)}
                                                onAdd={(val) => handleAddOption('styles', val)}
                                                listId="style-list"
                                                options={[...DEFAULT_STYLES, ...customOptions.styles]}
                                            />

                                            <CreatableSelect 
                                                label="產品/服務 Product" 
                                                icon={Briefcase}
                                                value={activeScript.formData.product} 
                                                onChange={(val) => updateFormData('product', val)}
                                                onAdd={(val) => handleAddOption('services', val)}
                                                listId="service-list"
                                                options={[...DEFAULT_SERVICES, ...customOptions.services]}
                                            />

                                            <div>
                                                <label className="text-sm font-bold text-black uppercase tracking-wider block mb-1">補充重點</label>
                                                <input type="text" value={activeScript.formData.notes} onChange={(e) => updateFormData('notes', e.target.value)} className="w-full border-b-2 border-stone-300 py-1.5 text-base text-black focus:outline-none focus:border-black bg-transparent placeholder-stone-400" />
                                            </div>
                                        </div>
                                        <div className="flex flex-col gap-2">
                                            <button onClick={handleGenerate} disabled={isGenerating} className="w-full py-3 bg-stone-800 hover:bg-stone-700 text-white text-sm font-bold rounded shadow-lg shadow-stone-200">{isGenerating ? <RefreshCcw className="animate-spin w-4 h-4" /> : <Sparkles className="w-4 h-4 text-amber-300" />} 生成腳本</button>
                                        </div>
                                    </div>
                                )}

                                {apiError && <div className="max-w-[297mm] mx-auto mb-4 p-3 bg-red-50 text-red-600 text-xs border border-red-200 rounded flex items-center print:hidden"><AlertCircle size={14} className="mr-2"/> {apiError}</div>}

                                {/* 橫式腳本預覽 (Landscape) - 使用共用元件 ScriptPaper */}
                                {activeScript && (
                                    <div ref={scriptRef} className="capture-target">
                                        <ScriptPaper 
                                            script={activeScript} 
                                            isPrinting={isCapturing} // 截圖模式時視為列印狀態
                                            onChange={handlePaperChange}
                                            onDeleteRow={handleDeleteRow}
                                        />
                                    </div>
                                )}
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
